{% extends "base.html" %}

{% block title %}Utilisateurs ‚Äî TeamMove{% endblock %}

{% block extra_css %}
<style>
  .page-title { font-size: clamp(1.3rem,3vw,1.85rem); font-weight:800; letter-spacing:-.03em; display:flex; align-items:center; gap:.75rem; }
  .page-sub   { font-size:.82rem; color:rgba(240,244,255,.35); margin-top:.25rem; }

  /* Role badges */
  .role-badge {
    display:inline-flex; align-items:center; gap:.3rem;
    font-size:.68rem; font-weight:700; border-radius:20px;
    padding:.22em .7em; border:1px solid; white-space:nowrap;
  }
  .role-admin   { background:rgba(247,201,72,.12); color:#f7c948; border-color:rgba(247,201,72,.3); }
  .role-resp    { background:rgba(79,142,247,.12);  color:#4f8ef7; border-color:rgba(79,142,247,.3); }
  .role-lecteur { background:rgba(6,214,160,.1);    color:#06d6a0; border-color:rgba(6,214,160,.25); }

  /* Status badges */
  .status-actif   { background:rgba(6,214,160,.1);    color:#06d6a0; border:1px solid rgba(6,214,160,.25);    border-radius:20px; padding:.2em .7em; font-size:.7rem; font-weight:700; }
  .status-inactif { background:rgba(255,107,107,.1);  color:#ff6b6b; border:1px solid rgba(255,107,107,.25);  border-radius:20px; padding:.2em .7em; font-size:.7rem; font-weight:700; }

  /* Table */
  .table-wrap {
    background: var(--bg-card); border:1px solid var(--border);
    border-radius: var(--r-xl); overflow:hidden;
  }
  .table thead th {
    background: rgba(255,255,255,.03);
    font-size:.67rem; font-weight:700; text-transform:uppercase;
    letter-spacing:.1em; color:var(--text-muted);
    border-bottom:1px solid var(--border); padding:.85rem 1rem;
  }
  .table tbody td {
    padding:.85rem 1rem; font-size:.84rem;
    color:var(--text-secondary); border-color:var(--border); vertical-align:middle;
  }
  .table tbody tr:hover td { background:rgba(255,255,255,.025); }
  .table tbody tr:last-child td { border-bottom:none; }

  /* Form styles */
  .form-label { font-size:.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:.06em; margin-bottom:.4rem; }
  .form-control, .form-select {
    background:rgba(255,255,255,.05); border:1px solid var(--border-md);
    border-radius:var(--r-md); color:var(--text-primary);
    font-size:.85rem; padding:.55rem .85rem; transition:var(--t-fast);
  }
  .form-control:focus, .form-select:focus {
    background:rgba(255,255,255,.08); border-color:rgba(79,142,247,.55);
    box-shadow:0 0 0 3px rgba(79,142,247,.12); color:var(--text-primary); outline:none;
  }
  .form-select option { background:#1a1d2e; }

  .role-info-box {
    border-radius: var(--r-lg); padding:.75rem 1rem;
    font-size:.78rem; line-height:1.6;
    border:1px solid; margin-top:.75rem;
  }
  .role-info-box i { margin-right:.35rem; }
</style>
{% endblock %}

{% block content %}

<!-- ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ -->
<div class="d-flex justify-content-between align-items-start mb-4 flex-wrap gap-3">
  <div>
    <h2 class="page-title">
      <i class="fas fa-user-shield" style="background:linear-gradient(135deg,#f7c948,#fb923c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;"></i>
      Gestion des Utilisateurs
    </h2>
    <p class="page-sub">G√©rez les acc√®s et les r√¥les des utilisateurs</p>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
    <i class="fas fa-user-plus me-2"></i>Nouvel Utilisateur
  </button>
</div>

<!-- ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ -->
<div class="table-wrap">
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Nom d'utilisateur</th>
          <th>Email</th>
          <th>R√¥le</th>
          <th>Statut</th>
          <th>Derni√®re connexion</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        {% if user.username != 'Hammouda' %}
        <tr class="{{ '' if user.is_active else '' }}" style="{{ 'opacity:.55;' if not user.is_active else '' }}">
          <td>
            <div style="display:flex;align-items:center;gap:.65rem;">
              <div style="width:32px;height:32px;border-radius:10px;
                background:linear-gradient(135deg,rgba(79,142,247,.2),rgba(155,92,246,.2));
                display:flex;align-items:center;justify-content:center;
                font-size:.75rem;font-weight:800;color:#4f8ef7;flex-shrink:0;">
                {{ user.username[0]|upper }}</div>
              <div>
                <div style="font-weight:700;font-size:.88rem;">{{ user.username }}</div>
                {% if user.id == current_user.id %}
                  <span style="font-size:.6rem;background:rgba(79,142,247,.15);color:#4f8ef7;border:1px solid rgba(79,142,247,.3);border-radius:20px;padding:.1em .5em;font-weight:700;">Vous</span>
                {% endif %}
              </div>
            </div>
          </td>
          <td style="font-size:.82rem;color:var(--text-muted);">{{ user.email }}</td>
          <td>
            {% if user.role == 'admin' %}
              <span class="role-badge role-admin"><i class="fas fa-crown"></i>Administrateur</span>
            {% elif user.role == 'responsable_projet' %}
              <span class="role-badge role-resp"><i class="fas fa-briefcase"></i>Resp. Projet</span>
            {% else %}
              <span class="role-badge role-lecteur"><i class="fas fa-eye"></i>Lecteur</span>
            {% endif %}
          </td>
          <td>
            {% if user.is_active %}
              <span class="status-actif"><i class="fas fa-circle" style="font-size:.45rem;margin-right:.3rem;"></i>Actif</span>
            {% else %}
              <span class="status-inactif"><i class="fas fa-ban" style="font-size:.65rem;margin-right:.3rem;"></i>Inactif</span>
            {% endif %}
          </td>
          <td style="font-family:var(--font-mono,monospace);font-size:.78rem;">
            {% if user.last_login %}
              {{ user.last_login.strftime('%d/%m/%Y %H:%M') }}
            {% else %}
              <span style="color:var(--text-disabled);">Jamais</span>
            {% endif %}
          </td>
          <td>
            {% if user.id != current_user.id %}
            <form method="POST" action="{{ url_for('main.toggle_user', id=user.id) }}" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn btn-sm {{ 'btn-outline-danger' if user.is_active else 'btn-outline-success' }}"
                      style="font-size:.74rem;padding:.3rem .7rem;">
                {% if user.is_active %}
                  <i class="fas fa-user-slash me-1"></i>D√©sactiver
                {% else %}
                  <i class="fas fa-user-check me-1"></i>Activer
                {% endif %}
              </button>
            </form>
            {% else %}
            <span style="font-size:.72rem;color:var(--text-disabled);">‚Äî</span>
            {% endif %}
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL ‚Äî AJOUTER UTILISATEUR
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-plus me-2"></i>Nouvel Utilisateur
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form method="POST" action="{{ url_for('main.add_user') }}" id="userForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">

          <!-- Username -->
          <div class="mb-3">
            <label class="form-label">Nom d'utilisateur *</label>
            <div class="input-group">
              <span class="input-group-text" style="background:rgba(255,255,255,.05);border-color:var(--border-md);color:var(--text-muted);">
                <i class="fas fa-user" style="font-size:.8rem;"></i>
              </span>
              <input type="text" class="form-control" name="username" required
                     pattern="[a-zA-Z0-9_]{3,20}"
                     title="3-20 caract√®res, alphanum√©riques et underscore uniquement"
                     placeholder="Ex : jean.dupont">
            </div>
            <div class="form-text" style="font-size:.72rem;color:var(--text-disabled);">3 √† 20 caract√®res, sans espaces</div>
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label class="form-label">Email *</label>
            <div class="input-group">
              <span class="input-group-text" style="background:rgba(255,255,255,.05);border-color:var(--border-md);color:var(--text-muted);">
                <i class="fas fa-envelope" style="font-size:.8rem;"></i>
              </span>
              <input type="email" class="form-control" name="email" required placeholder="email@exemple.com">
            </div>
          </div>

          <!-- R√¥le -->
          <div class="mb-3">
            <label class="form-label">R√¥le *</label>
            <select class="form-select" name="role" id="roleSelect" required onchange="updateRoleInfo()">
              <option value="lecteur">üëÅÔ∏è Lecteur ‚Äî Vue seule</option>
              <option value="responsable_projet">üìã Responsable Projet ‚Äî Soumet des d√©placements</option>
              <option value="admin">üëë Administrateur ‚Äî Acc√®s complet</option>
            </select>

            <!-- Role info box -->
            <div id="roleInfoBox" class="role-info-box" style="background:rgba(6,214,160,.07);border-color:rgba(6,214,160,.2);color:#06d6a0;"></div>
          </div>

          <!-- Mot de passe -->
          <div class="mb-3">
            <label class="form-label">Mot de passe *</label>
            <div class="input-group">
              <span class="input-group-text" style="background:rgba(255,255,255,.05);border-color:var(--border-md);color:var(--text-muted);">
                <i class="fas fa-lock" style="font-size:.8rem;"></i>
              </span>
              <input type="password" class="form-control" name="password" id="password"
                     required minlength="8"
                     pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}"
                     title="8 caract√®res min, 1 majuscule, 1 minuscule, 1 chiffre"
                     placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()"
                      style="border-color:var(--border-md);background:rgba(255,255,255,.05);color:var(--text-muted);">
                <i class="fas fa-eye" id="toggleIcon" style="font-size:.8rem;"></i>
              </button>
            </div>
            <div class="form-text" style="font-size:.72rem;color:var(--text-disabled);">8 min ¬∑ 1 majuscule ¬∑ 1 minuscule ¬∑ 1 chiffre</div>
            <div class="progress mt-2" style="height:4px;background:rgba(255,255,255,.06);border-radius:99px;">
              <div class="progress-bar" id="passwordStrength" style="width:0%;border-radius:99px;transition:width .3s;"></div>
            </div>
          </div>

          <!-- Confirmer mot de passe -->
          <div class="mb-1">
            <label class="form-label">Confirmer le mot de passe *</label>
            <div class="input-group">
              <span class="input-group-text" style="background:rgba(255,255,255,.05);border-color:var(--border-md);color:var(--text-muted);">
                <i class="fas fa-lock" style="font-size:.8rem;"></i>
              </span>
              <input type="password" class="form-control" name="password_confirm" id="passwordConfirm" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="invalid-feedback" id="matchError" style="font-size:.75rem;">Les mots de passe ne correspondent pas</div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save me-1"></i>Cr√©er l'utilisateur
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
/* ‚îÄ‚îÄ Role info descriptions ‚îÄ‚îÄ */
const ROLE_INFO = {
  lecteur: {
    style: 'background:rgba(6,214,160,.07);border-color:rgba(6,214,160,.2);color:#06d6a0;',
    icon:  'fas fa-eye',
    text:  'Acc√®s en <strong>lecture seule</strong> au Dashboard, aux Projets et aux D√©placements. Aucune modification possible.'
  },
  responsable_projet: {
    style: 'background:rgba(79,142,247,.07);border-color:rgba(79,142,247,.2);color:#4f8ef7;',
    icon:  'fas fa-briefcase',
    text:  'Peut <strong>consulter</strong> le Dashboard, les Projets et les D√©placements. Peut <strong>soumettre</strong> des d√©placements sur des projets existants ‚Äî ils seront mis en attente de validation par l\'administrateur. Ne peut ni supprimer ni approuver.'
  },
  admin: {
    style: 'background:rgba(247,201,72,.07);border-color:rgba(247,201,72,.2);color:#f7c948;',
    icon:  'fas fa-crown',
    text:  'Acc√®s <strong>complet</strong> √† toutes les fonctionnalit√©s : personnels, projets, d√©placements, validations et gestion des utilisateurs.'
  }
};

function updateRoleInfo() {
  const role = document.getElementById('roleSelect').value;
  const box  = document.getElementById('roleInfoBox');
  const info = ROLE_INFO[role];
  if (!info) return;
  box.style.cssText = info.style;
  box.innerHTML = `<i class="${info.icon}"></i>${info.text}`;
}

/* ‚îÄ‚îÄ Toggle password visibility ‚îÄ‚îÄ */
function togglePassword() {
  const pwd  = document.getElementById('password');
  const icon = document.getElementById('toggleIcon');
  if (pwd.type === 'password') {
    pwd.type = 'text';
    icon.classList.replace('fa-eye', 'fa-eye-slash');
  } else {
    pwd.type = 'password';
    icon.classList.replace('fa-eye-slash', 'fa-eye');
  }
}

/* ‚îÄ‚îÄ Password strength ‚îÄ‚îÄ */
document.getElementById('password').addEventListener('input', function () {
  const pw  = this.value;
  const bar = document.getElementById('passwordStrength');
  let s = 0;
  if (pw.length >= 8)       s += 25;
  if (pw.match(/[a-z]+/))   s += 25;
  if (pw.match(/[A-Z]+/))   s += 25;
  if (pw.match(/[0-9]+/))   s += 25;
  bar.style.width = s + '%';
  bar.className   = 'progress-bar ' + (s < 50 ? 'bg-danger' : s < 75 ? 'bg-warning' : 'bg-success');
});

/* ‚îÄ‚îÄ Password match validation ‚îÄ‚îÄ */
document.getElementById('userForm').addEventListener('submit', function (e) {
  const pw  = document.getElementById('password').value;
  const cfw = document.getElementById('passwordConfirm').value;
  if (pw !== cfw) {
    e.preventDefault();
    document.getElementById('passwordConfirm').classList.add('is-invalid');
    document.getElementById('matchError').style.display = 'block';
  }
});

/* ‚îÄ‚îÄ Init role info box on page load ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', updateRoleInfo);
</script>
{% endblock %}