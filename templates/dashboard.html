{% extends "base.html" %}

{% block title %}Dashboard — TeamMove{% endblock %}

{% block extra_css %}
<style>
  /* ══ PAGE HEADER ══ */
  .page-title {
    font-size: clamp(1.3rem, 3vw, 1.85rem);
    font-weight: 800;
    letter-spacing: -0.03em;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .page-title i {
    background: linear-gradient(135deg, #f7c948, #fb923c);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .page-sub {
    font-size: 0.82rem;
    color: rgba(240,244,255,0.35);
    margin-top: 0.25rem;
  }

  /* ══ KPI CARDS ══ */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.85rem;
    margin-bottom: 1.75rem;
  }
  @media(max-width: 768px) { .kpi-grid { grid-template-columns: repeat(2,1fr); } }

  .kpi-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--r-xl);
    padding: 1.25rem 1.4rem;
    position: relative;
    overflow: hidden;
    transition: var(--t-base);
  }
  .kpi-card:hover { border-color: var(--border-md); transform: translateY(-2px); }

  /* Accent bar top */
  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--kpi-grad, var(--grad-primary));
  }
  .kpi-card.k2::before { background: linear-gradient(90deg,#06d6a0,#0ea5e9); }
  .kpi-card.k3::before { background: linear-gradient(90deg,#f7c948,#fb923c); }
  .kpi-card.k4::before { background: linear-gradient(90deg,#9b5cf6,#ec4899); }

  .kpi-icon {
    width: 42px; height: 42px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem;
    margin-bottom: 0.9rem;
  }
  .kpi-icon.blue  { background: rgba(79,142,247,.15);  color: #4f8ef7; }
  .kpi-icon.green { background: rgba(6,214,160,.15);   color: #06d6a0; }
  .kpi-icon.amber { background: rgba(247,201,72,.15);  color: #f7c948; }
  .kpi-icon.purple{ background: rgba(155,92,246,.15);  color: #9b5cf6; }

  .kpi-num {
    font-size: 2.2rem;
    font-weight: 800;
    letter-spacing: -0.05em;
    line-height: 1;
    color: var(--text-primary);
  }
  .kpi-label {
    font-size: 0.67rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-top: 0.3rem;
  }
  .kpi-sub {
    font-size: 0.7rem;
    color: rgba(240,244,255,.25);
    margin-top: 0.4rem;
    display: flex; align-items: center; gap: 0.3rem;
  }

  /* ══ SECTION LABELS ══ */
  .section-label {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 0.85rem;
    display: flex; align-items: center; gap: 0.5rem;
  }
  .section-label .badge-tag {
    font-size: 0.6rem;
    background: rgba(79,142,247,.15);
    color: #4f8ef7;
    border: 1px solid rgba(79,142,247,.25);
    border-radius: 20px;
    padding: .15em .6em;
    letter-spacing: .06em;
    font-weight: 700;
  }
  .section-label .badge-tag.dg {
    background: rgba(155,92,246,.15);
    color: #9b5cf6;
    border-color: rgba(155,92,246,.25);
  }

  /* ══ CHART CARDS ══ */
  .chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--r-xl);
    padding: 1.5rem;
    height: 100%;
    transition: var(--t-base);
  }
  .chart-card:hover { border-color: var(--border-md); }

  .chart-title {
    font-size: 0.82rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: 1.25rem;
    display: flex; align-items: center; gap: 0.5rem;
  }
  .chart-title i { font-size: 0.85rem; }

  /* ══ HORIZONTAL BAR (Top Personnel) ══ */
  .hbar-list { display: flex; flex-direction: column; gap: 0.85rem; }

  .hbar-item { }
  .hbar-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.35rem;
  }
  .hbar-name {
    font-size: 0.84rem; font-weight: 600;
    color: var(--text-secondary);
  }
  .hbar-val {
    font-family: var(--font-mono, monospace);
    font-size: 0.75rem; font-weight: 700;
    color: #4f8ef7;
    background: rgba(79,142,247,.1);
    border: 1px solid rgba(79,142,247,.2);
    border-radius: 20px;
    padding: .1em .6em;
  }
  .hbar-track {
    height: 7px;
    background: rgba(255,255,255,.05);
    border-radius: 99px;
    overflow: hidden;
  }
  .hbar-fill {
    height: 100%;
    border-radius: 99px;
    background: linear-gradient(90deg, #4f8ef7, #9b5cf6);
    transition: width 1.2s cubic-bezier(.16,1,.3,1);
  }
  .hbar-fill.rank-1 { background: linear-gradient(90deg,#f7c948,#fb923c); }
  .hbar-fill.rank-2 { background: linear-gradient(90deg,#06d6a0,#4f8ef7); }
  .hbar-fill.rank-3 { background: linear-gradient(90deg,#9b5cf6,#4f8ef7); }

  /* ══ DOUGHNUT (Sociétés) ══ */
  .donut-wrap {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    max-height: 200px;
  }

  /* ══ REGION BARS (DG chart) ══ */
  .region-list { display: flex; flex-direction: column; gap: 0.9rem; }
  .region-item { }
  .region-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 0.3rem;
  }
  .region-name {
    font-size: 0.84rem; font-weight: 600;
    color: var(--text-secondary);
    display: flex; align-items: center; gap: 0.45rem;
  }
  .region-name i { color: var(--text-muted); font-size: 0.7rem; }
  .region-val {
    font-family: var(--font-mono, monospace);
    font-size: 0.75rem; font-weight: 700;
    color: #9b5cf6;
    background: rgba(155,92,246,.1);
    border: 1px solid rgba(155,92,246,.2);
    border-radius: 20px;
    padding: .1em .6em;
  }
  .region-track {
    height: 6px;
    background: rgba(255,255,255,.05);
    border-radius: 99px;
    overflow: hidden;
  }
  .region-fill {
    height: 100%;
    border-radius: 99px;
    background: linear-gradient(90deg, #9b5cf6, #38bdf8);
    transition: width 1.2s cubic-bezier(.16,1,.3,1);
  }

  /* ══ RECENT TABLE ══ */
  .recent-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--r-xl);
    padding: 1.5rem;
    margin-top: 1.25rem;
  }

  .dur-badge {
    display: inline-flex; align-items: center; gap: 0.3rem;
    background: rgba(79,142,247,.1);
    border: 1px solid rgba(79,142,247,.2);
    color: #4f8ef7;
    border-radius: 20px;
    padding: 0.2em 0.7em;
    font-size: 0.72rem; font-weight: 700;
    font-family: var(--font-mono, monospace);
  }

  /* Empty state */
  .chart-empty {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    height: 180px;
    color: var(--text-muted); font-size: .83rem; gap: .5rem;
  }
  .chart-empty i { font-size: 2rem; opacity: .12; }
</style>
{% endblock %}

{% block content %}

<!-- ── PAGE HEADER ── -->
<div class="d-flex align-items-start justify-content-between mb-4 flex-wrap gap-3">
  <div>
    <h2 class="page-title"><i class="fas fa-chart-line"></i>Tableau de Bord</h2>
    <p class="page-sub">Vue d'ensemble — activité RH &amp; opérationnelle</p>
  </div>
  <span style="font-size:.72rem;color:var(--text-muted);align-self:center;">
    <i class="fas fa-circle me-1" style="font-size:.45rem;color:#06d6a0;"></i>
    Mis à jour en temps réel
  </span>
</div>

<!-- ── KPI CARDS ── -->
<div class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-icon blue"><i class="fas fa-users"></i></div>
    <div class="kpi-num">{{ total_personnels }}</div>
    <div class="kpi-label">Personnels actifs</div>
    <div class="kpi-sub"><i class="fas fa-circle" style="font-size:.4rem;color:#06d6a0;"></i> En activité</div>
  </div>
  <div class="kpi-card k2">
    <div class="kpi-icon green"><i class="fas fa-building"></i></div>
    <div class="kpi-num">{{ total_projets }}</div>
    <div class="kpi-label">Projets actifs</div>
    <div class="kpi-sub"><i class="fas fa-circle" style="font-size:.4rem;color:#06d6a0;"></i> Chantiers en cours</div>
  </div>
  <div class="kpi-card k3">
    <div class="kpi-icon amber"><i class="fas fa-route"></i></div>
    <div class="kpi-num">{{ total_deplacements }}</div>
    <div class="kpi-label">Déplacements total</div>
    <div class="kpi-sub"><i class="fas fa-circle" style="font-size:.4rem;color:#f7c948;"></i> Depuis le début</div>
  </div>
  <div class="kpi-card k4">
    <div class="kpi-icon purple"><i class="fas fa-calendar-check"></i></div>
    <div class="kpi-num">{{ total_deplacements_mois }}</div>
    <div class="kpi-label">Ce mois-ci</div>
    <div class="kpi-sub"><i class="fas fa-circle" style="font-size:.4rem;color:#9b5cf6;"></i> 30 derniers jours</div>
  </div>
</div>

<!-- ══════════════════════════════════════
     SECTION DRH
     ══════════════════════════════════════ -->
<div class="section-label mb-3">
  <i class="fas fa-id-badge" style="color:#4f8ef7;"></i>
  Analyse RH
  <span class="badge-tag">Directeur RH</span>
</div>

<div class="row g-3 mb-4">

  <!-- Chart 1 — Top personnels les plus mobiles (jours) -->
  <div class="col-md-6">
    <div class="chart-card h-100">
      <div class="chart-title">
        <i class="fas fa-medal" style="color:#f7c948;"></i>
        Top Personnels — Jours en Déplacement
      </div>
      {% if top_personnel_jours %}
        {% set max_jours = top_personnel_jours[0][1] %}
        <div class="hbar-list">
          {% for name, jours in top_personnel_jours %}
          <div class="hbar-item">
            <div class="hbar-header">
              <span class="hbar-name">
                {% if loop.index == 1 %}<i class="fas fa-crown" style="color:#f7c948;font-size:.7rem;margin-right:.3rem;"></i>{% endif %}
                {{ name }}
              </span>
              <span class="hbar-val">{{ jours }}j</span>
            </div>
            <div class="hbar-track">
              <div class="hbar-fill rank-{{ loop.index if loop.index <= 3 else '' }}"
                   style="width: {{ ((jours / max_jours) * 100)|round|int }}%"></div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="chart-empty">
          <i class="fas fa-user-clock"></i>
          Aucune donnée disponible
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Chart 2 — Déplacements par société (Doughnut) -->
  <div class="col-md-6">
    <div class="chart-card h-100">
      <div class="chart-title">
        <i class="fas fa-briefcase" style="color:#06d6a0;"></i>
        Déplacements par Société
      </div>
      {% if deps_par_societe %}
        <div class="donut-wrap">
          <canvas id="societeChart" height="200"></canvas>
        </div>
      {% else %}
        <div class="chart-empty">
          <i class="fas fa-building"></i>
          Aucune donnée disponible
        </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- ══════════════════════════════════════
     SECTION DG
     ══════════════════════════════════════ -->
<div class="section-label mb-3">
  <i class="fas fa-globe-africa" style="color:#9b5cf6;"></i>
  Vue Géographique
  <span class="badge-tag dg">Directeur Général</span>
</div>

<div class="row g-3 mb-4">

  <!-- Chart 3 — Répartition par région -->
  <div class="col-md-7">
    <div class="chart-card h-100">
      <div class="chart-title">
        <i class="fas fa-map-marked-alt" style="color:#9b5cf6;"></i>
        Déplacements par Région
      </div>
      {% if deps_par_region %}
        {% set max_region = deps_par_region[0][1] %}
        <div class="region-list">
          {% for region, nb in deps_par_region %}
          <div class="region-item">
            <div class="region-header">
              <span class="region-name">
                <i class="fas fa-map-pin"></i>{{ region|capitalize }}
              </span>
              <span class="region-val">{{ nb }} dépl.</span>
            </div>
            <div class="region-track">
              <div class="region-fill"
                   style="width: {{ ((nb / max_region) * 100)|round|int }}%"></div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="chart-empty">
          <i class="fas fa-map"></i>
          Aucune donnée géographique disponible
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Résumé textuel régions -->
  <div class="col-md-5">
    <div class="chart-card h-100">
      <div class="chart-title">
        <i class="fas fa-info-circle" style="color:#38bdf8;"></i>
        Synthèse Géographique
      </div>
      {% if deps_par_region %}
        <div style="display:flex;flex-direction:column;gap:.65rem;">
          {% for region, nb in deps_par_region %}
          <div style="
            display:flex;justify-content:space-between;align-items:center;
            padding:.65rem 1rem;
            background:rgba(155,92,246,{% if loop.index == 1 %}.1{% else %}.05{% endif %});
            border:1px solid rgba(155,92,246,{% if loop.index == 1 %}.2{% else %}.08{% endif %});
            border-radius:var(--r-lg);
          ">
            <div style="display:flex;align-items:center;gap:.6rem;">
              <div style="
                width:28px;height:28px;border-radius:8px;
                background:rgba(155,92,246,.15);
                display:flex;align-items:center;justify-content:center;
                font-size:.65rem;font-weight:800;color:#9b5cf6;
              ">{{ loop.index }}</div>
              <span style="font-size:.84rem;font-weight:600;color:var(--text-secondary);">
                {{ region|capitalize }}
              </span>
            </div>
            <div style="text-align:right;">
              <div style="font-size:1.1rem;font-weight:800;color:var(--text-primary);letter-spacing:-.03em;">{{ nb }}</div>
              <div style="font-size:.62rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;">déplacements</div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="chart-empty">
          <i class="fas fa-globe"></i>
          Aucune région renseignée
        </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- ══════════════════════════════════════
     TABLEAU RÉCENTS
     ══════════════════════════════════════ -->
<div class="recent-card">
  <div class="section-label" style="margin-bottom:1.25rem;">
    <i class="fas fa-history" style="color:#38bdf8;"></i>
    Derniers Déplacements Enregistrés
  </div>
  <div class="table-responsive">
    <table class="table" style="margin-bottom:0;">
      <thead>
        <tr>
          <th>Personnel</th>
          <th>Projet</th>
          <th>Début</th>
          <th>Fin</th>
          <th>Durée</th>
        </tr>
      </thead>
      <tbody>
        {% for dep in recent_deplacements %}
        <tr>
          <td>
            <div style="display:flex;align-items:center;gap:.6rem;">
              <div style="
                width:30px;height:30px;border-radius:10px;
                background:linear-gradient(135deg,rgba(79,142,247,.2),rgba(155,92,246,.2));
                display:flex;align-items:center;justify-content:center;
                font-size:.68rem;font-weight:800;color:#4f8ef7;
              ">{{ dep.personnel.nom[0] }}{{ dep.personnel.prenom[0] }}</div>
              <div>
                <div style="font-weight:700;font-size:.85rem;">
                  {{ dep.personnel.nom }} {{ dep.personnel.prenom }}
                </div>
                <div style="font-size:.68rem;color:var(--text-muted);">{{ dep.personnel.societe }}</div>
              </div>
            </div>
          </td>
          <td>
            <span style="
              display:inline-flex;align-items:center;gap:.3rem;
              background:rgba(56,189,248,.08);
              border:1px solid rgba(56,189,248,.2);
              color:#38bdf8;border-radius:20px;
              padding:.2em .7em;font-size:.75rem;font-weight:700;
            ">
              <i class="fas fa-map-pin" style="font-size:.6rem;"></i>
              {{ dep.projet.nom }}
            </span>
          </td>
          <td style="font-family:var(--font-mono,monospace);font-size:.78rem;">
            {{ dep.date_debut.strftime('%d/%m/%Y') }}
            <span style="color:rgba(240,244,255,.3);">{{ dep.heure_debut.strftime('%H:%M') }}</span>
          </td>
          <td style="font-family:var(--font-mono,monospace);font-size:.78rem;">
            {{ dep.date_fin.strftime('%d/%m/%Y') }}
            <span style="color:rgba(240,244,255,.3);">{{ dep.heure_fin.strftime('%H:%M') }}</span>
          </td>
          <td>
            {% set diff = (dep.date_fin - dep.date_debut).days + 1 %}
            <span class="dur-badge"><i class="fas fa-clock"></i>{{ diff }}j</span>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted);font-size:.85rem;">
            <i class="fas fa-route" style="display:block;font-size:1.8rem;opacity:.1;margin-bottom:.5rem;"></i>
            Aucun déplacement enregistré
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
// ── Chart defaults (dark theme) ──
Chart.defaults.color        = 'rgba(240,244,255,0.45)';
Chart.defaults.borderColor  = 'rgba(255,255,255,0.05)';
Chart.defaults.font.family  = "'Sora', sans-serif";

// ── Doughnut — Déplacements par société ──
{% if deps_par_societe %}
(function () {
  const ctx = document.getElementById('societeChart');
  if (!ctx) return;

  const labels = {{ deps_par_societe | map(attribute=0) | list | tojson }};
  const data   = {{ deps_par_societe | map(attribute=1) | list | tojson }};

  const COLORS = [
    'rgba(79,142,247,.78)',
    'rgba(6,214,160,.78)',
    'rgba(247,201,72,.78)',
    'rgba(155,92,246,.78)',
    'rgba(56,189,248,.78)',
    'rgba(255,107,107,.78)',
    'rgba(236,72,153,.78)',
    'rgba(16,185,129,.78)',
  ];

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: COLORS.slice(0, data.length),
        borderWidth: 2,
        borderColor: 'rgba(255,255,255,.06)',
        hoverBorderColor: 'rgba(255,255,255,.2)',
        hoverOffset: 8,
      }]
    },
    options: {
      responsive: true,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 14,
            boxWidth: 9,
            borderRadius: 5,
            usePointStyle: true,
            pointStyle: 'circle',
            font: { size: 11 },
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.label} : ${ctx.parsed} déplacement${ctx.parsed > 1 ? 's' : ''}`
          }
        }
      }
    }
  });
})();
{% endif %}

// ── Animate progress bars on load ──
(function () {
  // All hbar-fill and region-fill start at width:0 then animate to their target
  document.querySelectorAll('.hbar-fill, .region-fill').forEach(el => {
    const target = el.style.width;
    el.style.width = '0%';
    // Small delay so transition fires
    requestAnimationFrame(() => {
      requestAnimationFrame(() => { el.style.width = target; });
    });
  });
})();
</script>
{% endblock %}